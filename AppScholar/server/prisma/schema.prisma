// schema.prisma atualizado com modelo de Avisos

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String
  password  String
  role      String   @default("USER") // ADMIN, MANAGER, USER
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  aluno     Aluno?   @relation("UserAluno")
  avisos    Aviso[]  @relation("AvisoAutor") // ✅ Avisos criados pelo usuário

  @@map("User")
}

model Aluno {
  id         String   @id @default(uuid())
  nome       String
  email      String
  matricula  String   @unique
  curso      String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  userId     String?  @unique
  user       User?    @relation("UserAluno", fields: [userId], references: [id], onDelete: SetNull)

  notas      Nota[]

  @@index([userId])
  @@map("Aluno")
}

model Curso {
  id          String       @id @default(uuid())
  nome        String
  turno       String
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  disciplinas Disciplina[]

  @@map("Curso")
}

model Professor {
  id            String       @id @default(uuid())
  nome          String
  titulacao     String
  tempoDocencia String
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  disciplinas   Disciplina[]

  @@map("Professor")
}

model Disciplina {
  id           String     @id @default(uuid())
  nome         String
  cargaHoraria Int
  cursoId      String?
  professorId  String?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  
  curso        Curso?     @relation(fields: [cursoId], references: [id], onDelete: SetNull)
  professor    Professor? @relation(fields: [professorId], references: [id], onDelete: SetNull)
  notas        Nota[]

  @@index([cursoId])
  @@index([professorId])
  @@map("Disciplina")
}

model Nota {
  id           String     @id @default(uuid())
  disciplinaId String
  alunoId      String?
  n1           Float      @default(0)
  n2           Float      @default(0)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  disciplina   Disciplina @relation(fields: [disciplinaId], references: [id], onDelete: Cascade)
  aluno        Aluno?     @relation(fields: [alunoId], references: [id], onDelete: Cascade)

  @@unique([disciplinaId, alunoId])
  @@index([alunoId])
  @@map("Nota")
}

// ✅ NOVO: Modelo de Avisos Acadêmicos
model Aviso {
  id          String   @id @default(uuid())
  titulo      String
  conteudo    String   @db.Text
  tipo        String   // "institucional", "lembrete", "comunicado"
  prioridade  String   @default("normal") // "baixa", "normal", "alta", "urgente"
  publicadoEm DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relacionamento com o autor (User)
  autorId     String
  autor       User     @relation("AvisoAutor", fields: [autorId], references: [id], onDelete: Cascade)

  // Leituras dos avisos
  leituras    AvisoLeitura[]

  @@index([autorId])
  @@index([publicadoEm])
  @@index([tipo])
  @@map("Aviso")
}

// ✅ NOVO: Registro de leitura de avisos por usuário
model AvisoLeitura {
  id        String   @id @default(uuid())
  avisoId   String
  userId    String
  lidoEm    DateTime @default(now())
  
  aviso     Aviso    @relation(fields: [avisoId], references: [id], onDelete: Cascade)

  @@unique([avisoId, userId])
  @@index([userId])
  @@index([avisoId])
  @@map("AvisoLeitura")
}